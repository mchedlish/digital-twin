name: Destroy Environment

on:
    workflow_dispatch:
        inputs:
            environment:
                description: "Environment to destroy"
                required: true
                type: choice
                options:
                    - dev
                    - test
                    - prod
            confirm:
                description: "Type the environment name to confirm destruction"
                required: true

permissions:
    id-token: write
    contents: read

jobs:
    destroy:
        name: Destroy ${{ github.event.inputs.environment }}
        runs-on: ubuntu-latest
        environment: ${{ github.event.inputs.environment }}

        steps:
            - name: Verify confirmation
              run: |
                  if [ "${{ github.event.inputs.confirm }}" != "${{ github.event.inputs.environment }}" ]; then
                    echo "‚ùå Confirmation does not match environment name!"
                    echo "You entered: '${{ github.event.inputs.confirm }}'"
                    echo "Expected: '${{ github.event.inputs.environment }}'"
                    exit 1
                  fi
                  echo "‚úÖ Destruction confirmed for ${{ github.event.inputs.environment }}"

            - name: Checkout code
              uses: actions/checkout@v4

            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
                  role-session-name: github-actions-destroy
                  aws-region: ${{ secrets.DEFAULT_AWS_REGION }}

            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v3
              with:
                  terraform_wrapper: false # Important: disable wrapper to get raw outputs

            - name: Run Destroy Script
              run: |
                  # Set environment variables for the script
                  export AWS_ACCOUNT_ID=${{ secrets.AWS_ACCOUNT_ID }}
                  export DEFAULT_AWS_REGION=${{ secrets.DEFAULT_AWS_REGION }}

                  # Make script executable and run it
                  chmod +x scripts/destroy.sh
                  ./scripts/destroy.sh ${{ github.event.inputs.environment }} twin
              env:
                  AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

            - name: Verify Complete Cleanup
              if: always()
              run: |
                  echo "üîç Verifying all resources are removed..."
                  IAM_ROLE="twin-${{ github.event.inputs.environment }}-lambda-role"
                  if aws iam get-role --role-name "$IAM_ROLE" &>/dev/null; then
                    echo "‚ö†Ô∏è Warning: IAM role $IAM_ROLE still exists"
                  else
                    echo "‚úÖ IAM role removed successfully"
                  fi

            - name: Destruction Complete
              run: |
                  echo "‚úÖ Environment ${{ github.event.inputs.environment }} has been destroyed!"
